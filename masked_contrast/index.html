<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Mike Capp">
    <meta name="description"
        content="PoC for helping accessibility checkers consider CSS's text-shadow when assessing contrast">
    <title>masked contrast PoC - webtoys</title>
    <link rel="icon" href="data:,">
    <style>
        html,
        body,
        main,
        canvas,
        p,
        fieldset {
            margin: 0;
            padding: 0;
            line-height: normal;
        }

        main {
            position: relative;
            max-width: 50em;
            margin: 2em auto;
            font: 10pt sans-serif;
            background-color: white;
        }

        main > * { width: 500px; border: 1px solid black; box-sizing: border-box; }
        canvas#canvas, div#dom-div { height: 100px; position: relative; overflow: clip; }
        #dom-text { font: 48px sans-serif; position: absolute; }

        fieldset { margin-top: 8px; padding: 8px; }
        fieldset label { display: block; padding: 4px 0; }
        fieldset label > * { display: inline-block; }
        fieldset label span { width: 150px; }
        fieldset select { width: 320px; }
    </style>
</head>

<body>
    <main>
        <noscript>This webtoy uses JavaScript and won't work without it</noscript>
        <canvas id="canvas" aria-label="text drawn on a non-contrasting background">
            Your browser does not support the &lt;canvas> element
        </canvas>
        <div id="dom-div">
            <p id="dom-text"></p>
        </div>
        <fieldset>
            <legend>Demo configuration</legend>
            <label>
                <span>Draw using</span>
                <select id="renderer">
                    <option value="d">DOM text on a &lt;div> with a background-image</option>
                    <option value="c">Canvas calls for both text and background</option>
                </select>
            </label>
            <label>
                <span>Contrast enhancement</span>
                <select id="enhance">
                    <option value="0">None</option>
                    <option value="1">Weak text-shadow</option>
                    <option value="4">Strong text-shadow</option>
                </select>
            </label>
            <label>
                <span>Colour scheme</span>
                <select id="scheme">
                    <option value="e">Enhanced (white fill, pale bg, black shadow)</option>
                    <option value="g">Garish</option>
                    <option value="x">Stupid (white fill, bg, shadow)</option>
                </select>
            </label>
            <label>
                <span>Shadow offset</span>
                <select id="offset">
                    <option value="n">None</option>
                    <option value="t">Tasteful (2px)</option>
                    <option value="x">Silly (50px)</option>
                </select>
            </label>
        </fieldset>
    </main>
    <script>
        function $(qs) { return document.querySelector(qs); }
        function $$(qs) { return document.querySelectorAll(qs); }

        const elements = {
            canvas: $("canvas"),
            domDiv: $("#dom-div"),
            domText: $("#dom-text"),
        };

        const ctx = $("#canvas").getContext("2d");
        const text = "Hello, world!";
        const schemes = {
            e: { fg: "#eee", bg: "#def", ss: "#000" },
            g: { fg: "pink", bg: "darkblue", ss: "orange" },
            x: { fg: "white", bg: "white", ss: "white" }
        };
        const offsets = { n: 0, t: 2, x: 50 };
        const pos = { x: 200, y: 20 };

        // Called to repaint the world whenever anything changes; we're not getting incrementally fancy here
        //
        function update() {

            const useCanvas = $("#renderer").value === "c";
            elements.canvas.style.display = useCanvas ? "block" : "none";
            elements.domDiv.style.display = useCanvas ? "none" : "block";
            const enhance = Number.parseInt($("#enhance").value);
            const scheme = schemes[$("#scheme").value];
            const offset = offsets[$("#offset").value];
            
            if (useCanvas) {
                ctx.fillStyle = scheme.bg;
                ctx.fillRect(0, 0, 500, 100);
                ctx.font = "48px sans-serif";
                ctx.textBaseline = "top";
                if (enhance > 0) {
                    ctx.fillStyle = ctx.shadowColor = scheme.ss;
                    ctx.shadowBlur = 6.5;
                    ctx.shadowOffsetX = ctx.shadowOffsetY = offset;
                    for (let i = 0; i < enhance; ++i) {
                        ctx.fillText(text, pos.x, pos.y + 5);
                    }
                    ctx.shadowBlur = ctx.shadowOffsetX = ctx.shadowOffsetY = 0;
                }
                ctx.fillStyle = scheme.fg;
                ctx.fillText(text, pos.x, pos.y + 5);
            } else {
                elements.domDiv.style.backgroundColor = scheme.bg;
                elements.domDiv.style.color = scheme.fg;
                elements.domText.style.textShadow = (enhance > 0) 
                    ? Array(enhance).fill(`${offset}px ${offset}px 7px ${scheme.ss}`).join(", ")
                    : "none";
                elements.domText.style.left = pos.x + "px";
                elements.domText.style.top = pos.y + "px";
                elements.domText.textContent = text;
            }

            // Update the location hash to reflect current settings, allowing bookmarking and nondestructive reload
            //
            history.replaceState(undefined, undefined, "#" + Array.from($$("select")).map(e => e.value).join(""));

            $("#offset").disabled = (enhance == 0);
        }

        function populateFromHash() {
            const defaultHash = "d1en";
            var h = location.hash.replace("#", "").substr(0, defaultHash.length);
            h += defaultHash.substr(h.length);

            Array.from($$("select")).forEach(validatedSet);
            update();

            function validatedSet(el, i) {
                const v = h[i];
                const legit = Array.from(el.options).map(o => o.value);
                if (legit.includes(v)) {
                    el.value = v;
                } else {
                    alert(`'${v}' is not a valid value for '${el.id}', allowed values are [${legit}]`);
                    el.value = legit[0];
                }
            }
        }

        // One-time initialization
        //
        (function () {

            // Adjust canvas for high-DPI displays (untested, I don't have one)
            //
            const scale = window.devicePixelRatio;
            canvas.width = canvas.clientWidth * scale;
            canvas.height = canvas.clientHeight * scale;
            ctx.scale(scale, scale);

            window.addEventListener("hashchange", populateFromHash)
            document.querySelectorAll("select").forEach(el => el.addEventListener("click", update));

            populateFromHash();
        })();

        /*
        const metrics = ctx.measureText(text);
        console.log(`canvas text ascent = ${metrics.actualBoundingBoxAscent}, descent = ${metrics.actualBoundingBoxDescent}`);
        console.log(`DOM text offsetHeight = ${domText.offsetHeight}, offsetTop = ${domText.offsetTop}`);
        domText.style.top = `${50 - metrics.actualBoundingBoxAscent}px`;
        */
    </script>
</body>

</html>